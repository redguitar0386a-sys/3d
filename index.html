<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Skinned Real Hand</title>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  video { display:none; }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ===== THREE ===== */
const scene = new THREE.Scene();

const cam3D = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 2000);
cam3D.position.set(0, 0, 400);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.4));

const light = new THREE.DirectionalLight(0xfff0e0, 1.2);
light.position.set(300, 300, 300);
scene.add(light);

/* Hand model */
let hand, bones = {};

const loader = new THREE.GLTFLoader();
loader.load("hand.glb", gltf => {
  hand = gltf.scene;
  hand.scale.set(120, 120, 120);
  scene.add(hand);

  hand.traverse(o => {
    if (o.isBone) bones[o.name] = o;
    if (o.isMesh) {
      o.material.roughness = 0.4;
      o.material.metalness = 0.0;
    }
  });
});

/* ===== MEDIAPIPE ===== */
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

/* 角度計算 */
function angle(a, b, c) {
  const ab = new THREE.Vector3().subVectors(a, b).normalize();
  const cb = new THREE.Vector3().subVectors(c, b).normalize();
  return Math.acos(ab.dot(cb));
}

hands.onResults(r => {
  if (!r.multiHandLandmarks || !hand) return;

  const lm = r.multiHandLandmarks[0].map(p =>
    new THREE.Vector3(p.x, p.y, p.z)
  );

  const fingers = {
    index: [5,6,7,8],
    middle:[9,10,11,12],
    ring:  [13,14,15,16],
    pinky:[17,18,19,20],
    thumb:[1,2,3,4]
  };

  for (const f in fingers) {
    const ids = fingers[f];
    for (let i = 0; i < 3; i++) {
      const a = lm[ids[i]];
      const b = lm[ids[i+1]];
      const c = lm[ids[i+2]];
      const ang = angle(a,b,c);

      const bone = bones[`${f}_${i+1}`];
      if (bone) bone.rotation.x = -ang;
    }
  }
});

/* Camera */
const cam = new Camera(document.getElementById("video"), {
  onFrame: async () => hands.send({ image: video }),
  width: 1280,
  height: 720
});
cam.start();

/* Loop */
function loop() {
  requestAnimationFrame(loop);
  renderer.render(scene, cam3D);
}
loop();
</script>

</body>
</html>
